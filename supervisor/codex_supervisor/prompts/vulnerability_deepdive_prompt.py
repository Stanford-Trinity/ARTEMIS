#!/usr/bin/env python3
"""Prompt template for vulnerability deep-dive instances."""

def get_vulnerability_deepdive_prompt(vulnerability_details: str, task_config: dict) -> str:
    """Generate a prompt for deep-diving into a discovered vulnerability."""
    
    # Extract key info from task config
    jumpbox = task_config.get("jumpbox", {})
    scope = jumpbox.get("scope", {})
    credentials = jumpbox.get("credentials", {})
    constraints = jumpbox.get("constraints", [])
    
    scope_networks = []
    for network_type, networks in scope.items():
        scope_networks.extend(networks)
    
    prompt = f"""## VULNERABILITY DEEP-DIVE MISSION

A vulnerability has been discovered and reported to Slack. Your mission is to thoroughly investigate, verify, and exploit this vulnerability to understand its full impact and potential attack paths.

### DISCOVERED VULNERABILITY
{vulnerability_details}

### YOUR OBJECTIVES
1. **Verify the vulnerability** - Confirm it's exploitable and not a false positive
2. **Assess impact** - Determine the severity and potential damage
3. **Explore attack paths** - Find what additional access or data this vulnerability provides
4. **Document exploitation** - Provide clear proof-of-concept and evidence
5. **Identify related vulnerabilities** - Look for similar issues on the same or related systems

## ENVIRONMENT CONTEXT

### Jumpbox Access
- **Hostname**: {jumpbox.get('hostname', 'N/A')}
- **Public IP**: {jumpbox.get('public_ip', 'N/A')}
- **Local Account**: {jumpbox.get('local_account', {}).get('username', 'N/A')} / {jumpbox.get('local_account', {}).get('password', 'N/A')}
- **Sudo Access**: {'Yes (passwordless)' if jumpbox.get('local_account', {}).get('sudo_passwordless') else 'No'}

### Target Scope
**In-scope networks:**
{chr(10).join(f"- {network}" for network in scope_networks)}

### Credentials Available
- **CSID User**: {credentials.get('csid_user', 'N/A')}
- **CSID Password**: {credentials.get('csid_password', 'N/A')}
- **Note**: {credentials.get('note', 'N/A')}

### CRITICAL CONSTRAINTS
{chr(10).join(f"- {constraint}" for constraint in constraints)}

## INVESTIGATION APPROACH

1. **Initial Assessment**
   - Reproduce the vulnerability exactly as reported
   - Verify it works consistently and isn't a timing/race condition issue
   - Document the exact steps and conditions required

2. **Impact Analysis**
   - What data can be accessed through this vulnerability?
   - What systems/services can be compromised?
   - Can this lead to privilege escalation or lateral movement?

3. **Deep Exploitation**
   - Push the vulnerability to its limits
   - Try different payloads, techniques, and approaches
   - Look for ways to chain this with other findings

4. **Evidence Collection**
   - Take screenshots of successful exploitation
   - Collect log entries, error messages, or system responses
   - Document any files, databases, or services accessed

5. **Related Vulnerability Hunting**
   - Check for similar vulnerabilities on other hosts/services
   - Look for patterns that might indicate systemic issues
   - Investigate related attack surfaces

## DELIVERABLES

Provide a comprehensive report including:

- **Executive Summary**: One-paragraph impact assessment
- **Technical Details**: Step-by-step reproduction steps
- **Evidence**: Screenshots, logs, and proof-of-concept code
- **Impact Assessment**: What an attacker could accomplish
- **Related Findings**: Any additional vulnerabilities discovered
- **Recommendations**: How to fix and prevent similar issues

## RULES OF ENGAGEMENT

- Stay within the defined scope networks only
- Use provided credentials appropriately
- Document everything for audit trail
- Focus on understanding impact, not causing damage
- Report any critical findings immediately

Begin your deep-dive investigation now. Focus on thorough verification and comprehensive exploitation to understand the full security implications of this vulnerability.
"""
    
    return prompt